---
title: "Data Cleaning"
author: "Eli Cohen, Sarah Tandean"
date: "2023-01-28"
output: pdf_document
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r}
## Data initialization

init.data = read.csv("Initial_Play_-_By_-_Play.csv")

# convert character variables to factor
factor.vars = c("ODK", "RESULT", "PLAY.TYPE")
init.data[factor.vars] = lapply(init.data[factor.vars], factor)

# renaming variables for convenience
names(init.data) = tolower(names(init.data))
names(init.data)[1] = "play"

# fixing rounding error for distance
gn.ls.lagged = lag(init.data$gn.ls)
dist.lagged = lag(init.data$dist)
#init.data$dist = dist.lagged - gn.ls.lagged

#head(init.data$dist, 20)

head(init.data)
```

```{r}
## Cleaning

# creating game ID
first.plays = which(init.data$play==1)
init.data$game = length(first.plays)
for (i in 1:(length(first.plays)-1)) {
  first = first.plays[i]
  last = first.plays[i+1]-1
  init.data$game[first:last] = i
}

# fixing yards to endzone
negative.yds = init.data$yard.ln < 0
na.yds = is.na(negative.yds)
negative.yds[na.yds] = FALSE
init.data[negative.yds, "yard.ln"] = init.data[negative.yds, "yard.ln"] + 100
names(init.data)[5] = "yds.to.endzone"

# creating drive ID
init.data$drive = rep(0, dim(init.data)[1])
prev.plays = 1
drive.preceders = c("KO", "KO Rec", "Onside Kick Rec")
drive.starters = c("Fumble", "Interception", "Sack, Fumble")
drive.enders = c("Punt Rec", "Punt", "Extra Pt.", "Extra Pt. Block", "FG Block",
                 "FG", "2 Pt.", "2 Pt. Defend")
num.games = max(init.data$game)

for (i in 1:num.games) {
  ind.game = init.data[init.data$game == i, ]
  num.plays = max(ind.game$play)
  drive.col = rep(0, num.plays)
  drive = 1
  
  for (j in 1:num.plays) {
    cur.result = ind.game[j, "result"]
    cur.play.type = ind.game[j, "play.type"]
    
    # if (cur.play.type %in% drive.preceders) {
    #   drive = drive + 1
    # }
    if ((cur.result %in% drive.starters) && 
             (ind.game[j, "odk"] != ind.game[j + 1, "odk"])) {
      drive = drive + 1
    }
    
    drive.col[j] = drive
    
    if (cur.play.type %in% drive.enders) drive = drive + 1
  }
  
  init.data[prev.plays:(num.plays + prev.plays - 1), "drive"] = drive.col
  prev.plays = prev.plays + num.plays
}

```


