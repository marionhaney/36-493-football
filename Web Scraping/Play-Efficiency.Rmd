---
title: "Play-Efficiency"
author: "Jordan Gilbert"
date: "2023-03-23"
output: pdf_document
---

```{r}
# Libraries
require(ggplot2)
require(tidyverse)
require(varhandle)
```

```{r}
# Read in data
data = read.csv("./CMU-2022-pbp3.csv")
#data = read.csv("./CMU-2022-pbp2.csv")
```

```{r}
# Manipulations
#data$Yards = as.numeric(data$Yards)
data$Distance.to.First.Down = as.numeric(data$Distance.to.First.Down)
```
```{r}
# Efficiency Model
data["Efficient"] = ifelse(data$Down == 1 & check.numeric(data$Yards) & as.numeric(data$Yards) >= 4, 1,
                    ifelse(data$Down == 2 & check.numeric(data$Yards) & as.numeric(data$Yards) > data$Distance.to.First.Down/2, 1,
                    ifelse(data$Down == 3 & check.numeric(data$Yards) & as.numeric(data$Yards) > data$Distance.to.First.Down, 1,
                    ifelse(data$Down == 4 & check.numeric(data$Yards) & as.numeric(data$Yards) > data$Distance.to.First.Down, 1,
                            0))))
#1st Down: 4 Yards or more
#2nd Down: Gaining Half of the required distance for the First Down
#3rd Down: Converting the First Down
#4th Down: Converting the First Down
data$Down = as.factor(data$Down)
```
```{r}
CMUOffense = subset(data, data$Team.Possession == "Carnegie Mellon")
```


```{r}
# CMU Offense
means <- aggregate(Efficient ~ Down, CMUOffense, mean)
ggplot(CMUOffense, aes(Down, Efficient, fill = Down)) +
  geom_boxplot() +
  stat_summary(fun=mean, geom='point', shape=20, size = 8) +
  geom_text(data = means, aes(label = round(Efficient, 4), y = Efficient + 0.08)) +
  labs(title = "CMU Offense Effiency per Down")
```

```{r}
CMUDefense = subset(data, data$Team.Possession != "Carnegie Mellon")
```

```{r}
means <- aggregate(Efficient ~ Down, CMUDefense, mean)
ggplot(CMUDefense, aes(Down, Efficient, fill = Down)) +
  geom_boxplot() +
  stat_summary(fun=mean, geom='point', shape=20, size = 8) +
  geom_text(data = means, aes(label = round(Efficient, 4), y = Efficient + 0.08))
```

```{r}
ggplot(CMUOffense, aes(x = Down, y = Efficient / nrow(CMUOffense), 
                       label = scales::percent(Efficient / nrow(CMUOffense)))) +
  geom_bar(stat = "identity", aes(fill = Down)) +
  geom_col(position = "dodge") +
  geom_text(vjust = 0) +
  #geom_text(aes(y = Efficient / nrow(CMUOffense), label = scales::percent(Efficient / nrow(CMUOffense))),
  #          stat="identity", vjust=-0.5) +
  scale_y_continuous(labels = scales::percent) +
  geom_errorbar(aes(ymin = (Efficient / nrow(CMUOffense)), ymax = (Efficient / nrow(CMUOffense)), color = "orange"))
  

#helper = data %>% group_by(Down) %>% summarise_at(vars(Efficient), list(name = sd, counts = length))

#ggplot(df,aes(x))+geom_bar(aes(y=(..count..)/sum(..count..)))+scale_y_continuous(labels
#=percent_format())

#ggplot(CMUOffense) +
#    geom_bar(aes(x=Down), y=helper$counts, fill="skyblue", alpha=0.7) +
#    geom_errorbar(aes(x=Down, ymin=Efficient-helper$name , 
#                      ymax=Efficient+helper$name), width=0.4, colour="orange", alpha=0.9, size=1.3)
```


```{r}
# ANOVA
one_way = aov(Efficient ~ Down, CMUOffense)
summary(one_way)

# Proportion Table
prop.table(table(CMUOffense$Down, CMUOffense$Efficient), 1)
```

